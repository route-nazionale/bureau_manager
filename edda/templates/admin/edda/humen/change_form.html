{% extends "admin/edda/change_form.html" %}
{% load i18n %}

{% block submit_buttons_bottom %}
    {% if not user.is_readonly %}
        {{ block.super }}
        {% if change %}
            {% if not original.arrivato_al_quartiere and original.vclan.arrivato_al_campo %}
                <button name="_check_in_quartiere" href="do-check-in-quartiere/" class="btn btn-high btn-success bureau-buttons" type="submit">CONFERMA L'ARRIVO</button>
            {% elif original.arrivato_al_quartiere %}
                <button name="_is_here" class="btn" disabled="disabled" type="submit" style="border-color:red; font-weight:bold">È QUI CON NOI IN ROUTE!</button>
            {% endif %}
            {% if original.arrivato_al_quartiere or original.arrivato_al_quartiere == None %}
                <button name="_set_retired_quartiere" href="do-set-retired-quartiere/" class="btn btn-high btn-danger bureau-buttons" type="submit">REGISTRA CHE QUESTA PERSONA NON VIENE</button>
                <button name="_set_substitution" href="do-prepare-substitution/" class="btn btn-high btn-danger" type="submit">SOSTITUISCI QUESTA PERSONA CON UN'ALTRA DEL SUO CLAN</button>
            {% else %}
                <label name="_retired" class="btn" disabled="disabled" style="border-color:red; font-weight:bold">NON VIENE IN ROUTE</label>
                <button name="_set_null_arrived_quartiere" href="do-set-null-arrived-quartiere/" class="btn btn-high btn-warning bureau-buttons" type="submit">IMPOSTA ARRIVO SCONOSCIUTO (ripristina valore iniziale)</button>
            {% endif %}

            {% if original.arrivato_al_quartiere != None and not original.sostituito_da_set.count %}
                <button name="_set_null_arrived_quartiere" href="do-set-null-arrived-quartiere/" class="btn btn-high btn-warning bureau-buttons" type="submit">IMPOSTA ARRIVO SCONOSCIUTO (ripristina valore iniziale)</button>
            {% endif %}
            <button name="_print_badge" href="do-humen-print-badge/" class="btn btn-high btn-success" type="submit">STAMPA BADGE</button>

        <script type="text/javascript">
            $('button[name=_set_substitution]').click(function (e) {
                var el = $(e.target);
                $.post(el.attr('href'), {})
                    .done(function(data) {
                        if (data.url !== undefined) {
                            window.location.href = data.url;
                        }
                        else
                            alert("Ritorno inaspettato: " + data)
                    });
                e.stopPropagation();
                return false;
            });
            
            $('button[name=_print_badge]').click(function (e) {
                if(!confirm('Se stampi un nuovo badge, quello vecchio non sarà più valido. Sei sicuro?')) {
                  e.stopPropagation();
                  return false;
                }
                //window.location.href = 'do-print-badge/';
                window.open('do-humen-print-badge/', '_blank');
                e.stopPropagation();
                return false;
            });

            $('.bureau-buttons').click(function (e) {
                var el = $(e.target);
                $.post(el.attr('href'), {})
                    .done(function(data) {
                        if (data != "OK") {
                            alert("Non hai i permessi necessari per eseguire l'operazione");
                        } else {
                            alert('Operazione "' + el.text() + '" eseguita con successo! Attendere che la pagina si ricarichi...');
                            window.location.reload();
                        }
                    })
                    .fail(function(data) {
                        alert("Non hai i permessi necessari per eseguire l'operazione");
                    });
            
                e.stopPropagation();
                return false;
            });
        </script>
        {% endif %}
    {% endif %}
{% endblock %}

{% block object-tools %}
  {% if not is_popup and change or request.GET.vclan_id %}
    <h4 class="italic-title">{% trans 'tools'|capfirst %}</h4>
    <ul class="box menu-box">
    {% block object-tools-items %}

    {% if change and original.vclan %}
        <li><a href="{% url 'admin:edda_vclans_change' original.vclan.pk %}" class="actionlink" ><i
            class="icon-time icon-alpha75"></i>VAI AL SUO CLAN</a>
        </li>
    {% elif request.GET.vclan_id %}
        <li><a href="{% url 'admin:edda_vclans_change' request.GET.vclan_id %}" class="actionlink" ><i
            class="icon-time icon-alpha75"></i>VAI AL SUO CLAN</a>
        </li>
    {% endif %}
    {% comment %}
    <li><a href="do-set-retired-quartiere/" class="actionlink" dove="QUARTIERE"><i
        class="icon-time icon-alpha75"></i>REGISTRA CHE QUESTA PERSONA NON VIENE</a>
    </li>
    <script type="text/javascript">
        $('.actionlink').click(function (e) {
            var el = e.target;
            $.post(el.href, { 
                success : function(response) {
                    alert('Operazione "' + el.innerHTML + '" eseguita con successo!');
                }
            });
        
            e.stopPropagation();
            return false;
        });
    </script>
    {% endcomment %}
    {% endblock %}
   {% endif %}
{% endblock %}

{% block sidebar_content %}
{% if request.GET.vclan_id %}
<script type="text/javascript">
    $('#id_vclan').val({{ request.GET.vclan_id }});
    $('#id_scout').prop('checked', true);
</script>
{% endif %}
{% endblock %}
